<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/style1.css">
<title>Expense Tracker Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="loadDashboard()">

<header>
    <h2>Expense Tracker</h2>
    <button class="logout" onclick="logout()">Logout</button>
</header>

<div class="container">

    
    <div class="cards">
        <div class="card">
            <h3>Total Expense</h3>
            <p id="totalExpense">₹0</p>
        </div>
        <div class="card">
            <h3>Total Categories</h3>
            <p id="totalCategory">6</p>
        </div>
    </div>

  
    <div class="form-box">
        <h3>Add / Update Expense</h3>
        <input type="number" id="amount" placeholder="Amount">
        <input type="text" id="description" placeholder="Description">

        <select id="category">
            <option value="Food">Food</option>
            <option value="Travel">Travel</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Shopping">Shopping</option>
            <option value="Bills">Bills</option>
            <option value="Others">Others</option>
        </select>

        <input type="date" id="date">

<button onclick="saveExpense()">Save Expense</button>
    </div>

    
    <h3>My Expenses</h3>
    <ul id="expenseList"></ul>

    
    <div class="chart-box">
        <h3>Category Wise Expense</h3>
        <canvas id="expenseChart"></canvas>
    </div>
    <div class="card">
    <h3>Monthly Income</h3>
<input type="number" id="monthlyIncome" placeholder="Enter income" oninput="loadMonthlyData()">
    
</div>

<div class="card">
    <h3>Monthly Expense</h3>
    <p id="monthlyExpense">₹0</p>
</div>

<div class="card">
    <h3>Balance</h3>
    <p id="balance">₹0</p>
</div>

<br>

<label>Select Month:</label>
<input type="month" id="monthPicker" onchange="loadMonthlyData()">


</div>

<script>
const API = "http://localhost:8080/api/expenses";
let editId = null;
let chart = null;

function loadMonthlyData() {
    const user = JSON.parse(localStorage.getItem("user"));
    const monthValue = document.getElementById("monthPicker").value;

    if (!monthValue) return;

    const [year, month] = monthValue.split("-");

    fetch(`http://localhost:8080/api/expenses/monthly?userId=${user.id}&year=${year}&month=${month}`)
    .then(res => res.json())
    .then(data => {

        let totalExpense = 0;
        data.forEach(e => totalExpense += Number(e.amount));

        document.getElementById("monthlyExpense").innerText = "₹" + totalExpense;

        calculateBalance(totalExpense);
        renderChart(data);
        renderExpenseList(data);
    });
}
function calculateBalance(expense) {
    const income = Number(document.getElementById("monthlyIncome").value) || 0;

    const balance = income - expense;

    const balanceEl = document.getElementById("balance");
    balanceEl.innerText = "₹" + balance;

    // If negative → red
    if (balance < 0) {
        balanceEl.style.color = "red";
    } else {
        balanceEl.style.color = "green";
    }
}


function checkAuth() {
    if (!localStorage.getItem("token")) {
        window.location.href = "login.html";
    }
}

function logout() {
    localStorage.clear();
    window.location.href = "login.html";
}


function loadDashboard() {
    const user = JSON.parse(localStorage.getItem("user"));

    fetch(API)
    .then(res => res.json())
    .then(data => {

        // Filter only logged-in user's expenses
        const userExpenses = data.filter(e => e.userId === user.id);

        const list = document.getElementById("expenseList");
        list.innerHTML = "";

        let total = 0;

        userExpenses.forEach(e => {
            total += Number(e.amount);

            list.innerHTML += `
                <li>
                    ${e.description} - ₹${e.amount} (${e.category})
                    <button onclick="editExpense(${e.id})">Edit</button>
                    <button onclick="deleteExpense(${e.id})">Delete</button>
                </li>
            `;
        });

        // Update total expense (if you have this element)
        const totalEl = document.getElementById("totalExpense");
        if (totalEl) {
            totalEl.innerText = "₹" + total;
        }

        // Render pie chart
        renderChart(userExpenses);
    })
    .catch(err => console.error("Error loading dashboard:", err));
}




function saveExpense() {
    const user = JSON.parse(localStorage.getItem("user"));

    const expense = {
        amount: document.getElementById("amount").value,
        description: document.getElementById("description").value,
        category: document.getElementById("category").value,
        date: document.getElementById("date").value,   // NEW
        userId: user.id
    };

    if (!expense.amount || !expense.description || !expense.date) {
        alert("Please fill all fields");
        return;
    }

    if (editId) {
        fetch(API + "/" + editId, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(expense)
        }).then(() => {
            editId = null;
            loadDashboard();
        });
    } else {
        fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(expense)
        }).then(loadDashboard);
    }
}




function editExpense(id) {
    fetch(API + "/" + id)
    .then(res => res.json())
    .then(e => {
        document.getElementById("amount").value = e.amount;
        document.getElementById("description").value = e.description;
        document.getElementById("category").value = e.category;
        document.getElementById("date").value = e.date;   // NEW
        editId = id;
    });
}




function deleteExpense(id) {
    if (confirm("Delete this expense?")) {
        fetch(API + "/" + id, {
            method: "DELETE"
        }).then(loadDashboard);
    }
}

function renderExpenseList(expenses) {
    const list = document.getElementById("expenseList");
    list.innerHTML = "";

    expenses.forEach(e => {
        list.innerHTML += `
            <li>
                ${e.description} - ₹${e.amount} (${e.category})
                <button onclick="editExpense(${e.id})">Edit</button>
                <button onclick="deleteExpense(${e.id})">Delete</button>
            </li>
        `;
    });
}


function resetForm() {
    amount.value = "";
    description.value = "";
    editId = null;
}


let chartInstance = null;

function renderChart(expenses) {

    let categoryTotals = {};

    // Calculate totals by category
    expenses.forEach(e => {
        if (!categoryTotals[e.category]) {
            categoryTotals[e.category] = 0;
        }
        categoryTotals[e.category] += Number(e.amount);
    });

    const labels = Object.keys(categoryTotals);
    const data = Object.values(categoryTotals);

    const ctx = document.getElementById("expenseChart").getContext("2d");

    // Destroy old chart before creating new
    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: "pie",
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    "#4e73df",
                    "#1cc88a",
                    "#36b9cc",
                    "#f6c23e",
                    "#e74a3b",
                    "#858796"
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: "bottom"
                }
            }
        }
    });
}

</script>

</body>
</html>
